# Server Components

리액트 서버 컴포넌트는 렌더링 및 선택적으로 서버에 캐시할 수 있는 UI를 작성할 수 있습니다. 넥스트에서 스트리밍과 부분 렌더링이 가능하도록 렌더링 작업을 루트 세그먼트별로 추가로 분할하며, 세 가지 서버 렌더링 전략이 있습니다.

- 정적 렌더링
- 동적 렌더링
- 스트리밍

이 페이지에서는 서버 컴포넌트가 어떻게 작동하고 언제 사용해야하는지, 그리고 서버 렌더링 전략의 차이점을 알아볼 것입니다.

## 서버 렌더링의 이점

서버에서 렌더링하는 것에는 몇 가지 이점이 있습니다.

- 데이터 페칭: 서버 컴포넌트는 데이터 페칭을 데이터 소스에 가까운 서버로 옮겨줍니다. 이것은 렌더링에 필요한 데이터 페치와 클라이언트가 요청해야 하는 요청의 수를 줄여 성능을 향상시킬 수 있습니다.
- 보안: 서버 컴포넌트는 민감한 데이터나 서버의 로직, 예를 들어 토큰이나 API keys 를 클라이언트에 노출될 위험 없이 보관할 수 있습니다.
- 캐싱: 서버에서 렌더링함으로서 결과는 캐시되고 연속적인 요청 및 사용자 간 재사용할 수 있습니다. 이것은 렌더링의 수와 각 요청의 데이터 페칭을 줄여 성능을 향상시키고 비용을 줄여줍니다.
- 번들 크기: 서버 컴포넌트는 이전에 클라이언트 자바스크립트 번들 크기에 영향을 주었던 큰 종속성을 유지할 수 있습니다. 이것은 클라이언트가 다운로드, 파싱 및 실행이 필요가 없기 때문에 느린 인터넷이나 오래된 장치를 사용하는 사용자에게 장점이 됩니다.
- 첫 페이지 로드 및 첫 내용 페인트 (Initial Page Load and First Contentful Paint): 서버에서는 HTML을 생성하여 페이지를 렌더링하기 위해 클라이언트가 자바스크립트 다운로드, 파싱, 실행을 기다리지 않고 사용자가 즉시 페이지를 볼 수 있습니다.
- 서치 엔진 최적화와 소셜 네트워크 공유: 렌더된 HTML은 서치 엔진 봇이 페이지를 색인하고 소셜 네트워크 봇이 소셜 카드 미리보기를 생성하도록 사용될 수 있습니다.
- 스트리밍: 서버 컴포넌트는 렌더링 작업을 덩어리로 나누고 준비가 되면 클라이언트가 스트리밍 하도록 합니다. 이렇게 하면 사용자는 전체 페이지가 모두 렌더링 되기를 기다릴 필요 없이 페이지를 일찍 볼 수 있습니다.

## 넥스트에서 서버 컴포넌트 사용

기본적으로 넥스트는 서버 컴포넌트를 사용합니다. 이것은 추가적인 설정 없이 자동으로 서버 렌더링을 하고 필요할 때는 클라이언트 컴포넌트를 설정할 수 있습니다.

## 서버 컴포넌트가 렌더링 되는 방식

서버에서 넥스트는 리액트 API를 사용하여 렌더링을 조정합니다. 렌더링 작업은 개별의 라우트 세그먼트와 서스펜스 바운더리로 청크 단위로 쪼개집니다.

각 청크는 두 단계로 렌더링됩니다.

1. 리액트는 서버 컴포넌트를 리액트 서버 컴포넌트 페이로드(RSC Payload)라고 불리는 특별한 데이터 포맷으로 렌더링합니다.
2. 넥스트는 RSC Payload와 클라이언트 컴포넌트 자바스크립트 명령을 사용하여 HTML으로 렌더링합니다.

그런 다음 클라이언트에서는:

1. 첫 페이지 로드에서만 - HTML은 라우트의 빠른 비 상호적인 미리보기를 보여주는 데에 사용됩니다.
2. 리액트 서버 컴포넌트 페이로드는 클라이언트와 서버 컴포넌트 트리를 조정하고 DOM을 업데이트 하는 데에 사용됩니다.
3. 자바스크립트 명령은 클라이언트 컴포넌트를 하이드레이트하고 어플리케이션을 상호작용 가능하게 만듭니다.

> 리액트 서버 컴포넌트 페이로드(RSC Payload)란 무엇일까요?
> RSC Payload는 렌더링된 리액트 컴포넌트 트리의 컴팩트 바이너리 표현입니다. 클라이언트에서 브라우저의 DOM을 업데이트 하는 데에 사용됩니다. RSC 페이로드에는 다음이 포함됩니다.
>
> - 서버컴포넌트의 렌더링 결과
> - 렌더되어야 하는 클라이언트 컴포넌트를 위한 플레이스 홀더와 그 자바스크립트 파일에 대한 참조
> - 서버 컴포넌트에서 클라이언트 컴포넌트로 전달하는 모든 props

## 서버 렌더링 전략

서버 렌더링에는 정적, 동적 및 스트리밍의 세 가지 하위 집합이 있습니다.

### 정적 렌더링(기본)

정적 렌더링을 사용하면, 라우트는 빌드 타임 혹은 데이터 재검증 후 백그라운드에서 라우트가 렌더링됩니다. 그 결과는 캐시되고 컨텐트 딜리버리 네트워크(CDN)에 푸시될 수 있습니다. 이 최적화는 렌더링 작업의 결과를 사용자와 서버 요청 간에 공유할 수 있습니다.

정적 렌더링은 라우트가 사용자에게 개인화되지 않은 데이터를 가지고 있고 정적 블로그 게시물 또는 제품 페이지와 같이 빌드 시 알 수 있는 경우에 유용합니다.

### 동적 렌더링

동적 렌더링을 사용하면 라우트는 사용자가 요청할 때에 렌더링됩니다.

동적 렌더링은 라우트가 사용자에게 개인화된 데이터가 있거나 쿠키 또는 URL의 서치파람스와 같이 요청 시에만 알 수 있는 정보가 있을 때 유용합니다.

> 캐시된 데이터가 있는 동적 라우트

대부분의 웹 사이트에서 경로는 완전히 정적이거나 완전히 동적인 것은 아닙니다. 이것은 스펙트럼입니다. 예를 들어, 캐시된 제품 데이터를 사용하여 간격을 두고 재검증되지만 캐시되지 않은 개인화된 고객 데이터가 있는 전자 상거래 페이지를 가질 수 있습니다.

넥스트에서 캐시된 데이터와 캐시되지 않은 데이터가 모두 있는 동적으로 렌더링된 라우트를 사용할 수 있습니다. 이는 RSC 페이로드와 데이터가 별도로 캐시되기 때문입니다. 이를 통해 요청 시 모든 데이터를 가져오는 것이 성능에 미치는 영향에 대한 걱정 없이 동적 렌더링을 선택할 수 있습니다.

>

**동적 렌더링으로 변경**

렌더링 중에 동적 함수나 캐시되지 않은 데이터 요청이 발견되면, 넥스트는 전체 라우트를 동적으로 렌더링 하도록 변경합니다. 아래 테이블은 동적 함수 및 데이터 캐싱이 경로를 정적으로 렌더링할지 또는 동적으로 렌더링할지 여부에 미치는 영향을 요약합니다.

| Dynamic Functions | Data       | Route                |
| ----------------- | ---------- | -------------------- |
| No                | Cached     | Statically Rendered  |
| Yes               | Cached     | Dynamically Rendered |
| No                | Not Cached | Dynamically Rendered |
| Yes               | Not Cached | Dynamically Rendered |

위의 테이블에서 완전히 정적 라우트가 되려면 모든 데이터가 캐시되어야 합니다. 그러나 캐시된 데이터와 캐시되지 않은 데이터 페치를 모두 사용하여 동적으로 렌더링된 라우트를 가질 수 있습니다.

개발자는 정적 렌더링과 동적 렌더링 중 하나를 선택할 필요가 없습니다. 넥스트는 사용되는 기능과 API를 기반으로 각 경로에 가장 적합한 렌더링 전략을 자동으로 선택합니다. 대신 특정 데이터를 캐시하거나 재검증할 시기를 선택하고 UI의 일부를 스트리밍하도록 선택할 수 있습니다.

**동적 기능**

동적 기능은 사용자의 쿠키, 현재 요청 헤더 또는 URL의 서치 파람스와 같은 요청 시에만 알 수 있는 정보에 의존합니다. 넥스트에서 이러한 동적 기능은 다음과 같습니다:

> - `cookies()` 와 `headers()` : 서버 컴포넌트에서 이것들을 사용하면 요청 시에 전체 라우트를 동적 렌더링으로 선택됩니다.
> - **`useSearchParams()`**:
>   - 클라이언트 컴포넌트에서는 정적 렌더링을 건너뛰고 클라이언트에서 가장 가까운 상위 서스펜스 경계까지 모든 클라이언트 구성요소를 렌더링합니다.
>   - `useSearchParams()` 를 사용하는 클라이언트 컴포넌트를 `<Suspense/>` 경계에 래핑하는 것을 추천합니다. 그러면 그 위에 있는 모든 클라이언트 컴포넌트가 정적으로 렌더링될 수 있습니다.
> - **`searchParams`**: Pages props를 사용하면 요청 시 페이지를 동적 렌더링으로 선택할 수 있습니다.

### 스트리밍

![](https://velog.velcdn.com/images/hyorimm/post/33ef334d-3e00-414f-abde-6053a361a911/image.png)

스트리밍을 사용하면 요청 시 서버에서 경로가 렌더링됩니다. 작업은 청크로 분할되어 준비가 되면 클라이언트로 스트리밍됩니다. 이를 통해 사용자는 페이지가 완전히 렌더링되기 전에 미리보기를 볼 수 있습니다.

![](https://velog.velcdn.com/images/hyorimm/post/d4abc7b4-8611-4763-9dba-fc3cfe7cdc66/image.png)

스트리밍은 우선 순위가 낮은 UI 또는 전체 경로에 대한 렌더링을 차단하는 느린 데이터 페칭에 의존하는 UI에 유용합니다. 예를 들어, 제품 페이지의 리뷰가 있습니다.

넥스트에서, 스트림 라우트 세그먼트는 `loading.js`를 사용하고 UI 컴포넌트는 React Suspension를 사용합니다.
